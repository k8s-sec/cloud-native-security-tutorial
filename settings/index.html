



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Getting started with cloud native security">
      
      
      
        <meta name="author" content="Liz Rice and Michael Hausenblas">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.4.0">
    
    
      
        <title>Secure settings - Cloud Native Security Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,400i,700|PT+Mono&display=fallback">
        <style>body,input{font-family:"Lato","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"PT Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#using-secure-kubernetes-settings" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Cloud Native Security Tutorial" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Cloud Native Security Tutorial
            </span>
            <span class="md-header-nav__topic">
              
                Secure settings
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/k8s-sec/cloud-native-security-tutorial/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    k8s-sec/cloud-native-security-tutorial
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Cloud Native Security Tutorial" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Cloud Native Security Tutorial
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/k8s-sec/cloud-native-security-tutorial/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    k8s-sec/cloud-native-security-tutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../preparation/" title="Preparation" class="md-nav__link">
      Preparation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Exercises
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Exercises
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../compromise/" title="Compromised pod" class="md-nav__link">
      Compromised pod
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../scanning/" title="Scanning" class="md-nav__link">
      Scanning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../policies/" title="Policies" class="md-nav__link">
      Policies
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Secure settings
      </label>
    
    <a href="./" title="Secure settings" class="md-nav__link md-nav__link--active">
      Secure settings
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-cis-kubernetes-benchmark" title="The CIS Kubernetes Benchmark" class="md-nav__link">
    The CIS Kubernetes Benchmark
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-benchmark-checks-with-kube-bench" title="Running benchmark checks with kube-bench" class="md-nav__link">
    Running benchmark checks with kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-kube-bench-on-the-kind-cluster" title="Run kube-bench on the kind cluster" class="md-nav__link">
    Run kube-bench on the kind cluster
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-kube-bench-job" title="Create the kube-bench job" class="md-nav__link">
    Create the kube-bench job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-job-output-from-the-logs" title="Get the job output from the logs" class="md-nav__link">
    Get the job output from the logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remediate-a-test" title="Remediate a test" class="md-nav__link">
    Remediate a test
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edit-the-kubelet-configuration-file" title="Edit the Kubelet configuration file" class="md-nav__link">
    Edit the Kubelet configuration file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-run-kube-bench" title="Re-run kube-bench" class="md-nav__link">
    Re-run kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-kube-bench-through-starboard" title="Running kube-bench through Starboard" class="md-nav__link">
    Running kube-bench through Starboard
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-exercises" title="Optional exercises" class="md-nav__link">
    Optional exercises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-a-specific-test" title="Run a specific test" class="md-nav__link">
    Run a specific test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specify-worker-node-tests-only" title="Specify worker node tests only" class="md-nav__link">
    Specify worker node tests only
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gitops/" title="GitOps" class="md-nav__link">
      GitOps
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Conclusion
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Conclusion
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../conclusions/" title="Conclusions" class="md-nav__link">
      Conclusions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-cis-kubernetes-benchmark" title="The CIS Kubernetes Benchmark" class="md-nav__link">
    The CIS Kubernetes Benchmark
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-benchmark-checks-with-kube-bench" title="Running benchmark checks with kube-bench" class="md-nav__link">
    Running benchmark checks with kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-kube-bench-on-the-kind-cluster" title="Run kube-bench on the kind cluster" class="md-nav__link">
    Run kube-bench on the kind cluster
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-kube-bench-job" title="Create the kube-bench job" class="md-nav__link">
    Create the kube-bench job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-job-output-from-the-logs" title="Get the job output from the logs" class="md-nav__link">
    Get the job output from the logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remediate-a-test" title="Remediate a test" class="md-nav__link">
    Remediate a test
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edit-the-kubelet-configuration-file" title="Edit the Kubelet configuration file" class="md-nav__link">
    Edit the Kubelet configuration file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-run-kube-bench" title="Re-run kube-bench" class="md-nav__link">
    Re-run kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-kube-bench-through-starboard" title="Running kube-bench through Starboard" class="md-nav__link">
    Running kube-bench through Starboard
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-exercises" title="Optional exercises" class="md-nav__link">
    Optional exercises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-a-specific-test" title="Run a specific test" class="md-nav__link">
    Run a specific test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specify-worker-node-tests-only" title="Specify worker node tests only" class="md-nav__link">
    Specify worker node tests only
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/k8s-sec/cloud-native-security-tutorial/edit/master/docs/settings.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="using-secure-kubernetes-settings">Using secure Kubernetes settings<a class="headerlink" href="#using-secure-kubernetes-settings" title="Permanent link">&para;</a></h1>
<p>When you install Kubernetes, there are numerous configuration settings that can affect security. In this section you'll learn about checking the settings in your cluster against the best practices advised by the Center for Internet Security.</p>
<h2 id="the-cis-kubernetes-benchmark">The CIS Kubernetes Benchmark<a class="headerlink" href="#the-cis-kubernetes-benchmark" title="Permanent link">&para;</a></h2>
<p>The CIS have many different benchmarks recommending how to configure software components with security best practices in mind. One such benchmark is for Kubernetes - in fact there are several editions for managed version of Kubernetes, like EKS or GKE, as well as for upstream Kubernetes installations.</p>
<p>There are hundreds of recommendations in these benchmarks, so running them manually on every node would be a time-consuming process.</p>
<h3 id="running-benchmark-checks-with-kube-bench">Running benchmark checks with kube-bench<a class="headerlink" href="#running-benchmark-checks-with-kube-bench" title="Permanent link">&para;</a></h3>
<p>The open source tool <a href="https://github.com/aquasecurity/kube-bench">kube-bench</a> makes it easy to run the tests defined in the CIS Kubernetes benchmark. In this tutorial, you will use kube-bench to identify some insecure Kubernetes settings, and you'll remediate one of the settings to turn a failing test into a pass.</p>
<p>You could run kube-bench in a cluster of your choice but for this tutorial we are showing it running in a kind (Kubernetes in Docker) single-node cluster that runs on your laptop as a Docker container.</p>
<h2 id="run-kube-bench-on-the-kind-cluster">Run kube-bench on the kind cluster<a class="headerlink" href="#run-kube-bench-on-the-kind-cluster" title="Permanent link">&para;</a></h2>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>What we are about to do is TERRIBLE practice but it makes it easier to write a platform-independent set of instructions for this tutorial. Never run YAML directly from the internet like this in your production cluster - check what's in it first!</p>
</div>
<h3 id="create-the-kube-bench-job">Create the kube-bench job<a class="headerlink" href="#create-the-kube-bench-job" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job.yaml</span>
</code></pre></div>
</td></tr></table>

<p>You can watch the job until it has completed:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl get jobs --watch</span>
</code></pre></div>
</td></tr></table>

<p>Hit Ctrl-C once the job has finished.</p>
<h3 id="get-the-job-output-from-the-logs">Get the job output from the logs<a class="headerlink" href="#get-the-job-output-from-the-logs" title="Permanent link">&para;</a></h3>
<p>The job applies the label <code>app: kube-bench</code> to the pod, so you can easily retrieve the logs like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl logs $(kubectl get pods -l app=kube-bench -o name)</span>
</code></pre></div>
</td></tr></table>

<p>Scroll back through the logs to see how it is divided into sections, each with its own set of results, remediation recommendations, and a summary.</p>
<p>Most of the tests pass but there are a few results marked with <code>[WARN]</code> or <code>[FAIL]</code></p>
<ul>
<li><code>[FAIL]</code> means that the test failed</li>
<li><code>[WARN]</code> indicates that you need to do something manually to verify whether the test should pass or not.</li>
</ul>
<p>For more detail on the output check the <a href="https://github.com/aquasecurity/kube-bench#output">kube-bench documentation</a>.</p>
<h2 id="remediate-a-test">Remediate a test<a class="headerlink" href="#remediate-a-test" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial was written using Kubernetes 1.18.2 and testing against the CIS Kubernetes Benchmark v1.5.1. If you are using a later version of Kubernetes, it's possible that the default configuration settings have changed and the results you get might not match what is described here.</p>
</div>
<p>Scroll back through the results to find the result and (further down the results) the remediation information for the test 4.2.6.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="p">...</span><span class="w"></span>

<span class="o">[</span><span class="n">FAIL</span><span class="o">]</span><span class="w"> </span><span class="mf">4.2.6</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="c1">--protect-kernel-defaults argument is set to true (Scored)</span>

<span class="p">...</span><span class="w"></span>

<span class="mf">4.2.6</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Kubelet</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="k">file</span><span class="p">,</span><span class="w"> </span><span class="n">edit</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="nl">protectKernelDefaults</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">.</span><span class="w"></span>
<span class="k">If</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">edit</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">kubelet</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">file</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="n">kubeadm</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">and</span><span class="w"></span>
<span class="k">set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">KUBELET_SYSTEM_PODS_ARGS</span><span class="w"> </span><span class="k">variable</span><span class="p">.</span><span class="w"></span>
<span class="c1">--protect-kernel-defaults=true</span>
<span class="n">Based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">system</span><span class="p">,</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">kubelet</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="w"> </span><span class="k">For</span><span class="w"> </span><span class="nl">example</span><span class="p">:</span><span class="w"></span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span><span class="w"></span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>Kind uses a kubelet configuration file that lives at <code>/var/lib/kubelet/config.yaml</code>, so only the first line of the remediation text applies - you don't have to worry about editing the kubelet service file or restarting the service.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using kind, there is a Docker container running your control plane. This image for this container is based on Ubuntu so we can exec into the running container and then treat it much as if it were a virtual machine running a Kubernetes node.</p>
</div>
<h3 id="edit-the-kubelet-configuration-file">Edit the Kubelet configuration file<a class="headerlink" href="#edit-the-kubelet-configuration-file" title="Permanent link">&para;</a></h3>
<p>First, open a shell into the kind container.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker exec -it kind-control-plane bash</span>
</code></pre></div>
</td></tr></table>

<p>Assuming that it doesn't already have an editor installed, you can add one.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">apt-get update</span>
<span class="err">apt-get install vim</span>
</code></pre></div>
</td></tr></table>

<p>Edit the Kubelet config file</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">vi /var/lib/kubelet/config.yaml</span>
</code></pre></div>
</td></tr></table>

<p>Add the line <code>protectKernelDefaults: true</code> so that the file looks something like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span> <span class="n">kubelet</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">authentication</span><span class="o">:</span>
  <span class="n">anonymous</span><span class="o">:</span>
    <span class="n">enabled</span><span class="o">:</span> <span class="kc">false</span>
<span class="o">...</span>
<span class="n">nodeStatusUpdateFrequency</span><span class="o">:</span> <span class="mi">0</span><span class="n">s</span>
<span class="n">protectKernelDefaults</span><span class="o">:</span> <span class="kc">true</span>
<span class="n">rotateCertificates</span><span class="o">:</span> <span class="kc">true</span>
<span class="o">...</span>
</code></pre></div>
</td></tr></table>

<p>Save the file. The kubelet will spot that the configuration has changed and update itself, but meanwhile you can <code>exit</code> to leave the container so that you are back at your terminal where you can run <code>kubectl</code> commands on the kind cluster.</p>
<h3 id="re-run-kube-bench">Re-run kube-bench<a class="headerlink" href="#re-run-kube-bench" title="Permanent link">&para;</a></h3>
<p>First delete the previous job:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl delete job kube-bench</span>
</code></pre></div>
</td></tr></table>

<p>Run the kube-bench job, as before:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job.yaml</span>
</code></pre></div>
</td></tr></table>

<p>Once the job has completed, get the test results from the logs</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl logs $(kubectl get pods -l app=kube-bench -o name)</span>
</code></pre></div>
</td></tr></table>

<p>This time you should see that test 4.2.6 passes. Congratulations, you have remediated a security setting on a Kubernetes node!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This only remediates the running node, of course! If you are managing your own Kubernetes nodes, it would be better to update the configuration settings you use in deployment scripts, so that the nodes are configured to run from the outset with the settings you want.</p>
</div>
<h2 id="running-kube-bench-through-starboard">Running kube-bench through Starboard<a class="headerlink" href="#running-kube-bench-through-starboard" title="Permanent link">&para;</a></h2>
<p>You can also use Starboard to run kube-bench and store the results in a Kubernetes CRD.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ kubectl starboard kube-bench
$ kubectl get ciskubebenchreports -o yaml
</code></pre></div>
</td></tr></table>

<p>These results can be easily viewed using Octant and the Octant Starboard plugin.</p>
<p>Using Starboard has the advantage that it will automatically run a <code>kube-bench</code> job on all the nodes in the cluster.</p>
<p><img alt="Octant deployment page showing CIS Kubernetes Benchmark results" src="../img/octant-kube-bench.png" /></p>
<h2 id="optional-exercises">Optional exercises<a class="headerlink" href="#optional-exercises" title="Permanent link">&para;</a></h2>
<p>If you download the <a href="https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job.yaml"><code>job.yaml</code></a> file used above, you can modify it to try some optional exercises.</p>
<h3 id="run-a-specific-test">Run a specific test<a class="headerlink" href="#run-a-specific-test" title="Permanent link">&para;</a></h3>
<p>Sometimes you might want to run an individual test rather than the whole benchmark. For example, try to modify the command run in the job so that it only runs the test 4.2.6 that you remediated earlier. You can do this by specifying <code>--check=4.2.6</code> as a parameter to the <code>kube-bench</code> command.</p>
<h3 id="specify-worker-node-tests-only">Specify worker node tests only<a class="headerlink" href="#specify-worker-node-tests-only" title="Permanent link">&para;</a></h3>
<p>There are different CIS Kubernetes Benchmark tests for different node types in the cluster (control plane nodes, worker nodes, etcd nodes). On a managed Kubernetes system you might only have access to worker nodes, so you only need to run the tests that apply to those nodes. <code>kube-bench</code> tries to auto-detect which tests to run on any given node, but to keep things simple you may wish to specify worker node tests only. You might like to try out the <a href="https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job-node.yaml"><code>job-node.yaml</code></a> configuration which does just that.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../policies/" title="Policies" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Policies
              </span>
            </div>
          </a>
        
        
          <a href="../gitops/" title="GitOps" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GitOps
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; Liz Rice and Michael Hausenblas
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:".."}})</script>
      
    
  </body>
</html>